<!doctype html>
<html>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/96/three.js"></script>
    <script>
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.1, 100 );

const renderer = new THREE.WebGLRenderer( { antialias: true } );
renderer.setPixelRatio( window.devicePixelRatio );
renderer.setSize( window.innerWidth, window.innerHeight );
document.body.appendChild(renderer.domElement);

const cubeMesh = (() => {
  const geometry = new THREE.BoxBufferGeometry(0.1, 0.1, 0.1);
  const material = new THREE.MeshPhongMaterial({
    color: 0xab47bc,
  });
  const mesh = new THREE.Mesh(geometry, material);
  mesh.position.y = 1.5;
  mesh.position.z = -1;
  mesh.rotation.order = 'YXZ';
  mesh.frustumCulled = false;
  return mesh;
})();
scene.add(cubeMesh);

let lastTime = 0;
function animate() {
  const now = Date.now();
  const timeDiff = now - lastTime;
  cubeMesh.rotation.x = (cubeMesh.rotation.y + timeDiff/1000 * Math.PI) % (Math.PI*2);

  requestAnimationFrame(animate);
  renderer.render(scene, camera);

  lastTime = now;
}

(async () => {
  const display = await navigator.xr.requestDevice();
  const session = await display.requestSession({
    exclusive: true,
  });
  display.session = session;

  session.onselect = e => {
    console.log('select'); // XXX
  };

  // console.log('request first frame');
  session.requestAnimationFrame((timestamp, frame) => {
    renderer.vr.setSession(session, {
      frameOfReferenceType: 'stage',
    });

    const viewport = session.baseLayer.getViewport(frame.views[0]);
    const width = viewport.width;
    const height = viewport.height;

    renderer.setSize(width * 2, height);

    renderer.setAnimationLoop(null);

    renderer.vr.enabled = true;
    renderer.vr.setDevice(display);
    renderer.vr.setAnimationLoop(animate);
  });
})();

console.log('loaded reality tab');
    </script>
  </body>
</html>
